---
import Layout from '../../layouts/Layout.astro';
import { fetchPosts } from '../api/api';
import matter from 'gray-matter';
import { marked } from 'marked';

const { slug } = Astro.params;

const { posts, hasError } = await fetchPosts();
if (hasError) {
  throw new Error('Error fetching posts data');
}

// Encontramos el post con el id igual a slug
const postMeta = posts.find((p: { id: string | undefined }) => p.id === slug);
if (!postMeta) {
  throw new Error('Post not found');
}

// Fetch del markdown desde la URL que da la API
const mdRes = await fetch(postMeta.url);
if (!mdRes.ok) {
  throw new Error('Error fetching markdown content');
}
const mdText = await mdRes.text();

// Extraemos frontmatter y contenido con gray-matter
const { data: frontmatter, content } = matter(mdText);

// Evita que el Markdown corte líneas en frases
// convierte los saltos de línea simples en espacio
const normalizedContent = content.replace(/(?<!\n)\n(?!\n)/g, ' ');

// Convertimos Markdown a HTML
const htmlContent = marked(normalizedContent, { breaks: true });

// Preparar props para Layout
const PAGE_PROPS = {
  title: frontmatter.title || 'Post',
  description: frontmatter.description || '',
  image: frontmatter.image?.url || '',
  imageAlt: frontmatter.image?.alt || '',
};

export const prerender = false;
---

<Layout {...PAGE_PROPS}>
<article class="mx-auto px-4 sm:px-6 lg:px-8 py-12 max-w-2xl">

    <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-6 leading-tight">
      {frontmatter.title}
    </h1>

    <div class="text-center text-gray-500 dark:text-gray-400 text-sm mb-8 space-x-2">
      {frontmatter.pubDate && (
        <time datetime={frontmatter.pubDate}>
          {new Date(frontmatter.pubDate).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })}
        </time>
      )}
      {frontmatter.author && <span>• {frontmatter.author}</span>}
    </div>

    {frontmatter.image?.url && (
      <div class="flex justify-center my-8">
        <img 
          src={frontmatter.image.url} 
          alt={frontmatter.image.alt || frontmatter.title} 
          class="rounded-xl shadow-lg w-full max-w-4xl object-cover"
        />
      </div>
    )}

    <div 
      set:html={htmlContent}
      class="prose prose-lg dark:prose-invert mx-auto max-w-none mt-10
             prose-headings:font-bold prose-headings:scroll-mt-20
             prose-img:rounded-lg prose-img:shadow-md
             prose-a:text-blue-600 dark:prose-a:text-blue-400"
    ></div>
  </article>
</Layout>
